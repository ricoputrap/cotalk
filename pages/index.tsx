import { Box, Flex } from '@chakra-ui/react';
import type { NextPage } from 'next'
import Head from 'next/head'
import React, { useEffect, useState } from 'react';
import * as io from "socket.io-client";
import ComposeBox from '../components/ComposeBox';
import MessageList from '../components/MessageList';
import styles from '../styles/Home.module.css'
import { Message } from '../types';

const Home: NextPage = () => {
  const [socket, setSocket] = useState<any>();
  const [receivedMessages, setReceivedMessages] = useState<Message[]>([]);

  useEffect(() => {
    const SOCKET_HOST: string = process.env.NEXT_PUBLIC_SOCKET_SERVER || "";
    const clientSocket = io.connect(SOCKET_HOST, {
      transports: ["websocket"]
    });

    setSocket(clientSocket);
  }, []);

  useEffect(() => {
    if (!socket) return;

    socket.on("receive_message", (data: any) => {
      setReceivedMessages((prevMessages: Message[]) => [
        ...prevMessages,
        {
          id: prevMessages.length,
          content: data.message,
          fromSender: false
        }
      ]);
    });
  }, [socket]);

  return (
    <div>
      <Head>
        <title>CoTalk - Let&apos;s talk with your coworker!</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={ styles.main }>
        <Box width="100%" height="100%" paddingX="200px">
          <Flex
            direction="column"
            backgroundColor="background"
            height="100%"
            padding="20px 20px 4px"
          >
            <MessageList messages={ receivedMessages } />

            <ComposeBox socket={socket} />
          </Flex>
        </Box>

      </main>

      <footer>
        
      </footer>
    </div>
  )
}

export default Home
